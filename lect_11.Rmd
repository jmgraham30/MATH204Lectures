---
title: "Lecture 11"
subtitle: " "
author: "JMG"
institute: "MATH 204"
output:
  xaringan::moon_reader:
    css: [rladies, rladies-fonts]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(openintro)
library(faraway)
library(tidyverse)
library(ggformula)
library(ggmosaic)
library(patchwork)
library(latex2exp)
library(kableExtra)
library(broom)
```


# Inference for Categorical Data

In this lecture, we will examine two new inferential techniques:

--

- Testing for goodness of fit using chi-square, which is applied to a categorical variable with more than two levels. This is commonly used in two circumstances:

--

  - Given a sample of cases that can be classified into several groups, determine if the sample is representative of the general population. 
  
--

  - Evaluate whether data resemble a particular distribution, such as a normal distribution or a geometric distribution. 
  
--

- Testing for independence in two-way tables. 

---

# Learning Objectives

- In this lecture, we cover some inferential techniques for categorical data. After this lecture you should be able to

--

  - Identify one-way and two-way table problems.
  
--

  - Work with a chi-square statistic and distribution.
  
--

  - Use the `aov` function in R to conduct hypothesis tests. 
---

# Video on Goodness of Fit

```{r,echo=FALSE}
vembedr::embed_url("https://youtu.be/Uk36WGxujkc") %>%
  vembedr::use_align("center")
```

---

# Video on Two-Way Tables


```{r,echo=FALSE}
vembedr::embed_url("https://youtu.be/yjrsfNdja0U") %>%
  vembedr::use_align("center")
```

---

# Motivating Example

Consider the following data:

--

```{r,echo=FALSE}
race_counts <- jury %>% group_by(race) %>% summarise(n=n())
jury_tb <- tibble(race=c("Representation in juries","Registered voters"),black=c(26,0.07),hispanic=c(25,0.12),white=c(205,0.72),other=c(19,0.09)) %>% mutate(total=black+hispanic+white+other)
jury_tb %>% kbl() %>% kable_styling()
```

--

We can compute the proportions for the data:

```{r,echo=FALSE}
race_counts %>% mutate(p = n/sum(n))
```

--

- We would like to know if the jury is representative of the population.

--

- This problem illustrates "Given a sample of cases that can be classified into several groups, determine if the sample is representative of the general population."

---

# One-Way Tables

- If we were to take the bottom row of the table on the last slide as the assumed true proportions, then we would expect to get the following so-called **one-way table**:

```{r,echo=FALSE}
jury_owtb <- tibble(race=c("Observed count","Expected count"),black=c(26,19.25),hispanic=c(25,33),white=c(205,198),other=c(19,24.75)) %>% mutate(total=black+hispanic+white+other)
jury_owtb %>% kbl() %>% kable_styling()
```

--

- From a one-way table we can produce a test statistic that follows a well-known distribution. Specifically, we compute

$$\frac{(26-19.25)^2}{19.25} + \frac{(25-33)^2}{33} + \frac{(205-198)^2}{198} + \frac{(19-24.75)^2}{24.75}$$

--

- This value is

```{r}
(26-19.25)^2/19.25 + (25-33)^2/33 + (205-198)^2/198 + (19-24.75)^2/24.75
```

---

# chi-Square Distributions

- In order to conduct inferences on data corresponding to one-way tables, we need to use a new distribution function called a **chi-square distribution**. Such distributions are characterized by a parameter called degrees of freedom. Below we plot a chi-square distribution function with 3 degrees of freedom:

```{r,fig.height=5}
gf_dist("chisq",df=3)
```


---

# chi-Square for Different df's

```{r,echo=FALSE,fig.height=6,fig.width=10,warning=FALSE,message=FALSE}
lab1 <- TeX("$df = 2$")
lab2 <- TeX("$df = 4$")
lab3 <- TeX("$df = 9$")

ggplot(data.frame(x = c(0, 25)), aes(x)) + 
  stat_function(fun = dchisq, args = list(df = 2), col='#88CCEE',lwd=1) +
  stat_function(fun = dchisq, args = list(df=4), col='#CC6677',lwd=1) + stat_function(fun = dchisq, args = list(df=9), col='#DDCC77',lwd=1) +
  annotate(geom="text",x=2.5,y=0.3,label=lab1,col="#88CCEE",size=6) + 
  annotate(geom="text",x=4,y=0.18,label=lab2,col="#CC6677",size=6) + 
  annotate(geom="text",x=12,y=0.1,label=lab3,col="#DDCC77",size=6)
```

---

# chi-Square Test Conditions

- In order to use a chi-square distribution to compute a p-value, we need to check two conditions:

--

  - Independence. Each case that contributes a count to the table must be independent of all the other cases in the table. 
  
--

  - Sample size / distribution. Each particular scenario must have at least 5 epxected cases. 


---

# chi-Square Test for One-Way Table

Suppose we are to evaluate whether there is convincing evidence that a set of observed counts $O_{1}$, $O_{2}$, $\ldots$, $O_{k}$ in $k$ categories are unusually different from what we might expect under a null hypothesis. Call the *expected counts* that are based on the null hypothesis $E_{1}$, $E_{2}$, $\ldots$, $E_{k}$. If each expected count is at least 5 and the null hypothesis is true, then the test statistic

$$X^{2} = \frac{(O_{1}-E_{1})^2}{E_{1}} + \frac{(O_{2}-E_{2})^2}{E_{2}} + \cdots + \frac{(O_{k}-E_{k})^2}{E_{k}}$$
follows a chi-square distribution with $k-1$ degrees of freedom. Note that this test statistic is always positive. 

--

The p-value for this test statistic is found by looking at the upper tail of htis chi-square distribution. We consider the upper tail becuase larger values of $X^2$ would provide greater evidence against the null hypothesis. 


---

# Example chi-Square Test

- We expect the statistic for the one-way table for the jury data to follow a chi-square distribution with 3 degrees of freedom (since there are $k=4$) categories. 

--

- Then the probability of observing a value that is as or more extreme that the value obtained from the sample data is

```{r}
1 - pchisq(5.89,3)
```

--

- Alternatively:

```{r}
pchisq(5.89,3,lower.tail = FALSE)
```

--

- We just computed a p-value, but to what null hypothesis does this p-value provide an appropriate means of testing? 

---

# Null Hypothesis for One-Way Tables

- In our example, we would want to test:

--

  - $H_{0}:$ The jurors are a random sample, that is, there is no racial bias in who serves on a jury, and the observed counts reflect natural sampling fluctuation. 
  
--

  - $H_{A}:$ The jurors are not randomly sampled, that is, there is racial bias in juror selection. 
  
--

- Using the data, we can conduct the chi-square test as follows:

```{r}
chisq.test(c(26,25,205,19),p=c(0.07,0.12,0.72,0.09))
```

---

# More Examples

- Let's work some more examples together.


---

# Two-Way Tables

- A one-way table describes counts for each outcome in a single categorical variable. 

--

- A two-way table descrives counts for combinations of two categorical variables. 

--

- When we consider a two-way table, we often would like to know, are these variables related in any way? That is, are they dependent versus independent? 


